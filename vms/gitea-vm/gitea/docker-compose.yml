networks:
  gitea:

volumes:
  gitea-data:
  postgres-data:
  runner-1-data:
  runner-2-data:

services:
  db:
    image: postgres:18-bookworm
    container_name: gitea-db
    restart: always
    env_file: .env
    networks:
      - gitea
    shm_size: 256mb
    volumes:
      - postgres-data:/var/lib/postgresql
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      PGDATA: ${PGDATA}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  gitea:
    image: docker.gitea.com/gitea:1.25.3
    container_name: gitea
    restart: always
    env_file: .env
    networks:
      - gitea
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - gitea-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "127.0.0.1:${GITEA_HTTP_PORT}:3000"
      - "${GITEA_SSH_PORT}:22"
    environment:
      USER_UID: ${USER_UID}
      USER_GID: ${USER_GID}
      GITEA__database__DB_TYPE: ${GITEA_DB_TYPE}
      GITEA__database__HOST: ${GITEA_DB_HOST}
      GITEA__database__NAME: ${GITEA_DB_NAME}
      GITEA__database__USER: ${GITEA_DB_USER}
      GITEA__database__PASSWD: ${GITEA_DB_PASSWD}
      GITEA__server__ROOT_URL: ${GITEA_ROOT_URL}
      GITEA__server__SSH_PORT: ${GITEA_SSH_PORT}
      GITEA__server__SSH_LISTEN_PORT: 22
      GITEA__server__LFS_JWT_SECRET: ${GITEA_LFS_JWT_SECRET}
      GITEA__security__SECRET_KEY: ${GITEA_SECRET_KEY}
      GITEA__security__INTERNAL_TOKEN: ${GITEA_INTERNAL_TOKEN}
      GITEA__oauth2__JWT_SECRET: ${GITEA_OAUTH2_JWT_SECRET}
      GITEA__actions__ENABLED: ${GITEA_ACTIONS_ENABLED}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/healthz"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  runner-1:
    image: gitea/act_runner:latest-dind
    container_name: gitea-runner-1
    restart: always
    privileged: true
    env_file: .env
    networks:
      - gitea
    depends_on:
      gitea:
        condition: service_healthy
    volumes:
      - runner-1-data:/data
      - ./config.yaml:/config.yaml:ro
    environment:
      CONFIG_FILE: /config.yaml
      GITEA_INSTANCE_URL: ${GITEA_INSTANCE_URL}
      GITEA_RUNNER_REGISTRATION_TOKEN: ${GITEA_RUNNER_REGISTRATION_TOKEN}
      GITEA_RUNNER_NAME: ${RUNNER_1_NAME}
      GITEA_RUNNER_LABELS: ${RUNNER_1_LABELS}

  runner-2:
    image: gitea/act_runner:latest-dind
    container_name: gitea-runner-2
    restart: always
    privileged: true
    env_file: .env
    networks:
      - gitea
    depends_on:
      gitea:
        condition: service_healthy
    volumes:
      - runner-2-data:/data
      - ./config.yaml:/config.yaml:ro
    environment:
      CONFIG_FILE: /config.yaml
      GITEA_INSTANCE_URL: ${GITEA_INSTANCE_URL}
      GITEA_RUNNER_REGISTRATION_TOKEN: ${GITEA_RUNNER_REGISTRATION_TOKEN}
      GITEA_RUNNER_NAME: ${RUNNER_2_NAME}
      GITEA_RUNNER_LABELS: ${RUNNER_2_LABELS}
